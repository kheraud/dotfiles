---
- name: Ensure locale package is available
  apt:
    name: locales
    state: present
  become: yes

- name: Ensure locales are available
  locale_gen:
    name: "{{ item }}"
    state: present
  loop: '{{ shell_locales
    | dict2items
    | selectattr("value", "search", ".UTF-8")
    | map(attribute="value")
    | list
    | unique }}'

- name: Ensure required locales are defined as expected
  ini_file:
    path: /etc/default/locale
    section: null
    no_extra_spaces: yes
    option: "{{ item.key }}"
    value: "{{ item.value }}"
    mode: 'u=rw,g=r,o=r'
    state: present
    backup: no
  loop: "{{ shell_locales|dict2items }}"
  become: yes
